# Руководство по генерации улучшенного датасета

## Обзор улучшений

Датасет теперь генерируется с двумя текстами и автоматическим исправлением грамматики:

1. **`text`** - грамматически правильный текст для оценки агента
2. **`text_for_tts`** - текст с датами прописью для синтеза аудио

## Ключевые компоненты

### 1. DateToTextConverter
Конвертирует даты в текстовое представление:
- `2026-02-03` → "третье февраля две тысячи двадцать шестого года"
- "через 3 дня" → "через три дня"

### 2. TextRephraser
Исправляет грамматические ошибки:
- **SimpleRephraser** (по умолчанию): правила для 20 городов России
- **TextRephraser** (опционально): перефразирование через LLM

### 3. Автоматические исправления

**Падежи городов:**
- ❌ "из Москва" → ✅ "из Москвы"
- ❌ "из Нижний Новгород" → ✅ "из Нижнего Новгорода"
- ❌ "в Москва" → ✅ "в Москву"

**Дни недели:**
- ❌ "на понедельник" → ✅ "в понедельник"
- ❌ "на пятница" → ✅ "в пятницу"

**Даты для TTS:**
- ❌ "2026-02-11" → ✅ "одиннадцатое февраля"
- ❌ "2026-12-31" → ✅ "тридцать первое декабря"

## Использование

### Базовое использование (с автоисправлением)

```bash
# Генерация 600 примеров с автоисправлением грамматики
python scripts/generate_dataset.py --count 600 --seed 42
```

### С LLM перефразированием (опционально)

```bash
# Требует настройки LLM провайдера
python scripts/generate_dataset.py \
    --count 600 \
    --use-llm-rephrase \
    --seed 42
```

### Параметры

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `--output` | Директория для сохранения | `data/datasets` |
| `--filename` | Имя файла датасета | `evaluation_dataset.json` |
| `--count` | Общее количество примеров | `600` |
| `--seed` | Seed для воспроизводимости | `42` |
| `--use-llm-rephrase` | Использовать LLM (требует настройки) | `False` |

## Формат датасета

### Пример записи

```json
{
  "id": "flight_001",
  "text": "Найди рейсы из Москвы в Санкт-Петербург на третье февраля",
  "text_for_tts": "Найди рейсы из Москвы в Санкт-Петербург на третье февраля две тысячи двадцать шестого года",
  "tool": "flight_schedule",
  "params": {
    "from_city": "Москва",
    "to_city": "Санкт-Петербург",
    "date": "2026-02-03"
  },
  "metadata": {
    "template_id": "flight_template_01",
    "complexity": "simple",
    "language": "ru",
    "llm_rephrased": false
  }
}
```

### Поля

- **`text`** - текст для оценки агента (с относительными датами, грамматически правильный)
- **`text_for_tts`** - текст для синтеза аудио (с датами прописью)
- **`tool`** - ожидаемый инструмент
- **`params`** - ожидаемые параметры
- **`metadata`** - метаданные (template_id, complexity, language, llm_rephrased)

## Примеры результатов

### До улучшений

```
Text: "Найди рейсы из Москва в Санкт-Петербург на 2026-02-03"
```

**Проблемы:**
- ❌ "из Москва" (неправильный падеж)
- ❌ "2026-02-03" (озвучится как число)

### После улучшений

```
Text:        "Найди рейсы из Москвы в Санкт-Петербург на третье февраля"
Text for TTS: "Найди рейсы из Москвы в Санкт-Петербург на третье февраля две тысячи двадцать шестого года"
```

**Улучшения:**
- ✅ "из Москвы" (правильный падеж)
- ✅ "третье февраля" (для оценки)
- ✅ "третье февраля две тысячи двадцать шестого года" (для TTS)

## Синтез аудио

Скрипт [`synthesize_audio.py`](synthesize_audio.py) автоматически использует `text_for_tts`:

```bash
python scripts/synthesize_audio.py \
    --input data/datasets/evaluation_dataset.json \
    --device cuda
```

Аудио будет синтезировано с корректным озвучиванием дат.

## Вспомогательные скрипты

### date_converter.py
Конвертер дат в текст. Можно использовать отдельно:

```bash
python scripts/date_converter.py
```

### text_rephraser.py
Перефразировщик текстов. Можно использовать отдельно:

```bash
python scripts/text_rephraser.py
```

## Тестирование

### Проверка качества текстов

```bash
# Генерируем небольшой датасет
python scripts/generate_dataset.py --count 20 --filename test.json

# Проверяем примеры
python -c "import json; data = json.load(open('data/datasets/test.json')); [print(f\"Text: {item['text']}\nTTS:  {item['text_for_tts']}\n\") for item in data[:5]]"
```

### Проверка исправлений

Все тексты автоматически проходят через SimpleRephraser, который исправляет:
- Падежи 20 городов России
- Предлоги с днями недели
- Конвертирует даты для TTS

## Поддерживаемые города

Автоматическое склонение для 20 городов:
- Москва, Санкт-Петербург, Казань, Екатеринбург
- Новосибирск, Сочи, Владивосток, Калининград
- Красноярск, Иркутск, Хабаровск, Краснодар
- Самара, Уфа, Челябинск, Омск
- Ростов-на-Дону, Нижний Новгород, Пермь, Воронеж

## Метрики качества

После улучшений ожидается:

| Метрика | До | После |
|---------|-----|--------|
| Грамматические ошибки | ~30% | <5% |
| Корректность дат в аудио | ~0% | >95% |
| Естественность текста | Средняя | Высокая |

## Дополнительная информация

- **Детальный план**: [`plans/008-evaluate-plan-update.md`](../plans/008-evaluate-plan-update.md)
- **Quick Start**: [`docs/evaluation_quickstart.md`](evaluation_quickstart.md)
- **Основной README**: [`scripts/README.md`](../scripts/README.md)
