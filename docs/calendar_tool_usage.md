# Использование инструмента календаря

## Обзор

Инструмент календаря позволяет добавлять события и получать список событий из календаря. Основное преимущество - поддержка **относительных дат** на русском языке, что делает взаимодействие с голосовым помощником естественным и удобным.

## Доступные инструменты

### 1. add_calendar_event - Добавление события

Добавляет новое событие в календарь.

**Параметры:**
- `date` (str) - Дата события (поддерживает относительные даты)
- `description` (str) - Описание события

**Примеры использования:**

```python
# Абсолютные даты
"Добавь встречу с командой на 2026-02-15"
"Запланируй презентацию на 15.02.2026"
"Создай событие на 15 февраля"

# Относительные даты
"Добавь встречу на завтра"
"Запланируй звонок на послезавтра"
"Напомни про отчет через 3 дня"

# Дни недели
"Добавь встречу на понедельник"
"Запланируй звонок на следующий вторник"
"Создай событие в пятницу"
```

### 2. get_calendar_events - Получение событий

Получает список событий из календаря с возможностью фильтрации.

**Параметры:**
- `date` (str, optional) - Дата или период для фильтрации
- `date_from` (str, optional) - Начало периода
- `date_to` (str, optional) - Конец периода

**Примеры использования:**

```python
# Конкретная дата
"Что у меня запланировано на завтра?"
"Покажи события на понедельник"
"Какие встречи 15 февраля?"

# Периоды
"Что у меня на следующей неделе?"
"Покажи события этого месяца"
"Какие встречи через 2 недели?"

# Все события
"Покажи все события в календаре"
```

## Поддерживаемые форматы дат

### Простые относительные даты

| Выражение | Описание | Пример результата (от 2026-02-02) |
|-----------|----------|-----------------------------------|
| сегодня | Текущий день | 2026-02-02 |
| завтра | Следующий день | 2026-02-03 |
| послезавтра | Через два дня | 2026-02-04 |
| вчера | Предыдущий день | 2026-02-01 |
| позавчера | Два дня назад | 2026-01-31 |

### Дни недели

| Выражение | Описание | Пример результата (от 2026-02-02, понедельник) |
|-----------|----------|-----------------------------------------------|
| понедельник | Ближайший понедельник (не сегодня) | 2026-02-09 |
| вторник | Ближайший вторник | 2026-02-03 |
| в среду | Ближайшая среда | 2026-02-04 |
| следующий четверг | Четверг следующей недели | 2026-02-12 |
| в пятницу | Ближайшая пятница | 2026-02-06 |

**Логика:**
- Если день недели уже прошел на этой неделе → следующая неделя
- Если день недели еще не наступил → эта неделя
- Префикс "следующий" → всегда следующая неделя

### Периоды (недели)

| Выражение | Описание | Пример результата (от 2026-02-02) |
|-----------|----------|-----------------------------------|
| эта неделя | От понедельника до воскресенья текущей недели | 2026-02-02 до 2026-02-08 |
| следующая неделя | От понедельника до воскресенья следующей недели | 2026-02-09 до 2026-02-15 |
| через неделю | Следующая неделя | 2026-02-09 до 2026-02-15 |
| через 2 недели | Через две недели | 2026-02-16 до 2026-02-22 |

### Периоды (месяцы)

| Выражение | Описание | Пример результата (от 2026-02-02) |
|-----------|----------|-----------------------------------|
| этот месяц | С 1-го по последнее число текущего месяца | 2026-02-01 до 2026-02-28 |
| следующий месяц | С 1-го по последнее число следующего месяца | 2026-03-01 до 2026-03-31 |

### Смещения

| Выражение | Описание | Пример результата (от 2026-02-02) |
|-----------|----------|-----------------------------------|
| через 3 дня | Через N дней | 2026-02-05 |
| через неделю | Через 7 дней (как период) | 2026-02-09 до 2026-02-15 |
| через месяц | Через 1 месяц | 2026-03-02 |
| через 2 месяца | Через N месяцев | 2026-04-02 |

### Абсолютные даты

| Формат | Пример | Описание |
|--------|--------|----------|
| YYYY-MM-DD | 2026-02-15 | ISO формат |
| DD.MM.YYYY | 15.02.2026 | Точечный формат |
| DD.MM.YY | 15.02.26 | Короткий год (добавляется 2000) |
| DD месяц | 15 февраля | Текстовый формат (год - текущий или следующий) |
| DD месяц YYYY | 15 марта 2026 | Текстовый формат с годом |

## Примеры сценариев использования

### Сценарий 1: Планирование встречи

**Пользователь:** "Запланируй встречу с Иваном на следующий вторник в 14:00"

**Обработка:**
1. LLM распознает запрос как `add_calendar_event`
2. Генерирует: `{date: "следующий вторник", description: "встреча с Иваном в 14:00"}`
3. DateParser преобразует "следующий вторник" в "2026-02-10"
4. Событие сохраняется в календарь

**Ответ:** "Событие добавлено на 2026-02-10: встреча с Иваном в 14:00"

### Сценарий 2: Просмотр событий на неделю

**Пользователь:** "Что у меня запланировано на следующей неделе?"

**Обработка:**
1. LLM распознает запрос как `get_calendar_events`
2. Генерирует: `{date: "следующая неделя"}`
3. DateParser преобразует в период: `{date_from: "2026-02-09", date_to: "2026-02-15"}`
4. Фильтруются события в этом периоде

**Ответ:**
```
Найдено событий в период 'следующая неделя': 3

• 2026-02-09: встреча с командой
• 2026-02-11: звонок с клиентом
• 2026-02-13: презентация проекта
```

### Сценарий 3: Быстрое добавление

**Пользователь:** "Напомни мне про звонок послезавтра"

**Обработка:**
1. LLM распознает запрос как `add_calendar_event`
2. Генерирует: `{date: "послезавтра", description: "напоминание про звонок"}`
3. DateParser преобразует "послезавтра" в "2026-02-04"
4. Событие сохраняется

**Ответ:** "Событие добавлено на 2026-02-04: напоминание про звонок"

## Обработка ошибок

### Некорректный формат даты

**Запрос:** "Добавь встречу на 32 февраля"

**Ответ:** "Не удалось распознать дату: 32 февраля. Не удалось распарсить дату: 32 февраля"

### Период вместо даты

**Запрос:** "Добавь встречу на следующую неделю"

**Ответ:** "Для добавления события укажите конкретную дату, а не период. Вы указали: 'следующая неделя' (период с 2026-02-09 по 2026-02-15)"

### Нет событий

**Запрос:** "Что у меня на завтра?"

**Ответ (если нет событий):** "На завтра нет запланированных событий"

## Технические детали

### Архитектура

```
Пользователь → LLM → CalendarTool → DateParser → ParsedDate → CSV файл
```

### Модули

- **[`src/tools/date_parser.py`](../src/tools/date_parser.py)** - Парсер дат
  - `ParsedDate` - Результат парсинга (дата или период)
  - `DateParser` - Основной парсер с методами для разных типов дат

- **[`src/tools/calendar.py`](../src/tools/calendar.py)** - Инструменты календаря
  - `AddCalendarEventToolImpl` - Добавление событий
  - `GetCalendarEventsToolImpl` - Получение событий

- **[`src/tools/schemas.py`](../src/tools/schemas.py)** - Pydantic схемы
  - `AddCalendarEventTool` - Схема для добавления
  - `GetCalendarEventsTool` - Схема для получения

### Хранение данных

События хранятся в CSV файле (по умолчанию `data/calendar.csv`):

```csv
date,description
2026-02-09,встреча с командой
2026-02-11,звонок с клиентом
2026-02-13,презентация проекта
```

### Конфигурация

Путь к файлу календаря настраивается в [`config/config.yml`](../config/config.yml):

```yaml
tools:
  calendar:
    enabled: true
    file_path: "data/calendar.csv"
```

## Тестирование

Модуль покрыт тестами:

```bash
# Тесты парсера дат
pytest tests/unit/test_date_parser.py -v

# Все тесты
pytest
```

## Ограничения

1. **Время события** - в описании, не парсится отдельно
2. **Повторяющиеся события** - не поддерживаются
3. **Напоминания** - не поддерживаются
4. **Интеграция с внешними календарями** - не поддерживается

## Дальнейшее развитие

Возможные улучшения:

1. Поддержка времени ("завтра в 15:00")
2. Повторяющиеся события ("каждый понедельник")
3. Относительные периоды ("последние 7 дней")
4. Праздники и особые даты ("на Новый год")
5. Умные напоминания ("за день до события")
6. Интеграция с Google Calendar, Outlook, iCal

## См. также

- [Детальный план разработки](../plans/005-calendar-feature-plan.md)
- [Основная документация](../README.md)
- [Тесты парсера дат](../tests/unit/test_date_parser.py)
