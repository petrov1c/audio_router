# Инструкция по использованию инструмента поиска авиарейсов

## Первоначальная настройка

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка API ключа

Получите API ключ Яндекс.Расписаний на https://developer.tech.yandex.ru/

Добавьте ключ в файл `.env`:

```bash
YANDEX_RASP_API_KEY=your_api_key_here
```

### 3. Загрузка справочника аэропортов

Запустите скрипт для загрузки списка всех аэропортов России:

```bash
python scripts/download_airports.py
```

Скрипт создаст файл `data/airports_russia.json` с кэшем аэропортов.

## Использование

### Через голосовой интерфейс

Запустите приложение:

```bash
python src/main.py
```

Откройте браузер по адресу `http://localhost:7860` и произнесите запрос:

- "Найди рейсы из Москвы в Питер на завтра"
- "Покажи самолёты из Сочи в Екатеринбург на 15 февраля"
- "Когда летят самолёты из Владивостока в Москву?"

### Программное использование

```python
from src.tools.flights import FlightsTool
from src.tools.schemas import FlightScheduleTool
from src.core.config import FlightsToolConfig

# Создание инструмента
config = FlightsToolConfig()
tool = FlightsTool(config)

# Инициализация (загрузка справочника аэропортов)
await tool.initialize()

# Поиск рейсов
params = FlightScheduleTool(
    tool="flight_schedule",
    from_city="Москва",
    to_city="Санкт-Петербург",
    date="2026-02-01"
)

result = await tool.execute(params)
print(result)
```

## Поддерживаемые форматы запросов

### Названия городов

Можно использовать различные варианты названий:

- **Москва**: "Москва", "москва", "МОСКВА"
- **Санкт-Петербург**: "Санкт-Петербург", "Питер", "СПб", "Петербург"
- **Сочи**: "Сочи", "Адлер"

### Названия аэропортов

Можно указывать конкретный аэропорт:

- "Шереметьево", "SVO"
- "Домодедово", "DME"
- "Внуково", "VKO"
- "Пулково", "LED"

### Формат даты

Дата должна быть в формате `YYYY-MM-DD`:

- "2026-02-01"
- "2026-12-31"

## Ограничения

### Поддерживаются только:

- ✅ Авиарейсы (самолёты)
- ✅ Внутренние рейсы по России

### Не поддерживаются:

- ❌ Международные рейсы
- ❌ Поезда
- ❌ Автобусы
- ❌ Электрички

При запросе неподдерживаемого типа транспорта или международного рейса, инструмент вежливо откажет и объяснит ограничение.

## Примеры ответов

### Успешный поиск

```json
{
  "success": true,
  "found": true,
  "count": 5,
  "total_found": 12,
  "from": "Москва",
  "from_airport": "Шереметьево",
  "to": "Санкт-Петербург",
  "to_airport": "Пулково",
  "date": "2026-02-01",
  "flights": [...],
  "message": "Найдено 5 авиарейсов из Москвы (Шереметьево) в Санкт-Петербург (Пулково) на 2026-02-01:\n1. Аэрофлот SU1234: вылет 10:00, прилёт 11:30 (1ч 30мин)\n..."
}
```

### Аэропорт не найден

```json
{
  "success": false,
  "error": "airport_not_found",
  "message": "Аэропорт отправления 'Мосва' не найден. Возможно вы имели в виду: Москва?",
  "suggestions": ["Москва", "Минеральные Воды", "Мурманск"]
}
```

### Рейсы не найдены

```json
{
  "success": true,
  "found": false,
  "message": "Прямых авиарейсов из Москвы в Санкт-Петербург на 2026-02-01 не найдено. Попробуйте выбрать другую дату или рассмотрите рейсы с пересадками.",
  "from": "Москва",
  "to": "Санкт-Петербург",
  "date": "2026-02-01"
}
```

### Международный рейс

```json
{
  "success": false,
  "error": "international_not_supported",
  "message": "Извините, я знаю расписание только по авиарейсам внутри России. Париж находится в стране: Франция",
  "from": "Москва",
  "to": "Париж"
}
```

## Обновление справочника аэропортов

Справочник автоматически обновляется раз в 30 дней (настраивается через `cache_ttl_days` в конфигурации).

Для принудительного обновления:

```bash
rm data/airports_russia.json
python scripts/download_airports.py
```

## Устранение неполадок

### Ошибка: "YANDEX_RASP_API_KEY не установлен"

Убедитесь что файл `.env` существует и содержит ключ:

```bash
cat .env | grep YANDEX_RASP_API_KEY
```

### Ошибка: "Не удалось загрузить справочник аэропортов"

Проверьте подключение к интернету и запустите скрипт загрузки:

```bash
python scripts/download_airports.py
```

### Аэропорт не находится

Попробуйте разные варианты названия:

- Полное название города
- Сокращённое название
- Название аэропорта
- IATA код (например, SVO, LED)

## Тестирование

### Запуск unit-тестов

```bash
pytest tests/unit/test_airport_registry.py -v
```

### Запуск integration-тестов

```bash
pytest tests/integration/test_flights_tool.py -v
```

### Запуск всех тестов

```bash
pytest tests/ -v
```

## Конфигурация

Настройки инструмента в `config/config.yml`:

```yaml
tools:
  flights:
    enabled: true
    cache_file: "data/airports_russia.json"
    cache_ttl_days: 30
    only_russia: true
    only_planes: true
```

Параметры:

- `enabled` - включить/выключить инструмент
- `cache_file` - путь к файлу кэша аэропортов
- `cache_ttl_days` - срок жизни кэша в днях
- `only_russia` - ограничение только на Россию
- `only_planes` - ограничение только на самолёты
