# Инструкция по использованию инструмента поиска авиарейсов

## Первоначальная настройка

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка API ключа

Получите API ключ Яндекс.Расписаний на https://developer.tech.yandex.ru/

Добавьте ключ в файл `.env`:

```bash
YANDEX_RASP_API_KEY=your_api_key_here
```

### 3. Загрузка справочника аэропортов

Запустите скрипт для загрузки списка всех аэропортов России:

```bash
python scripts/download_airports.py
```

Скрипт создаст файл `data/airports_russia.json` с кэшем аэропортов.

## Использование

### Через голосовой интерфейс

Запустите приложение:

```bash
python src/main.py
```

Откройте браузер по адресу `http://localhost:7860` и произнесите запрос:

- "Найди рейсы из Москвы в Питер на завтра"
- "Покажи самолёты из Сочи в Екатеринбург на 15 февраля"
- "Когда летят самолёты из Владивостока в Москву?"

### Программное использование

```python
from src.tools.flights import FlightsTool
from src.tools.schemas import FlightScheduleTool
from src.core.config import FlightsToolConfig

# Создание инструмента
config = FlightsToolConfig()
tool = FlightsTool(config)

# Инициализация (загрузка справочника аэропортов)
await tool.initialize()

# Поиск рейсов с абсолютной датой
params = FlightScheduleTool(
    tool="flight_schedule",
    from_city="Москва",
    to_city="Санкт-Петербург",
    date="2026-02-01"
)

result = await tool.execute(params)
print(result)

# Поиск рейсов с относительной датой
params = FlightScheduleTool(
    tool="flight_schedule",
    from_city="Москва",
    to_city="Санкт-Петербург",
    date="завтра"  # Относительная дата
)

result = await tool.execute(params)
print(result)
# {
#   "success": true,
#   "date": "2026-02-03",
#   "original_date": "завтра",
#   ...
# }

# Поиск рейсов на следующий понедельник
params = FlightScheduleTool(
    tool="flight_schedule",
    from_city="Москва",
    to_city="Сочи",
    date="следующий понедельник"
)

result = await tool.execute(params)
```

## Поддерживаемые форматы запросов

### Названия городов

Можно использовать различные варианты названий:

- **Москва**: "Москва", "москва", "МОСКВА"
- **Санкт-Петербург**: "Санкт-Петербург", "Питер", "СПб", "Петербург"
- **Сочи**: "Сочи", "Адлер"

### Названия аэропортов

Можно указывать конкретный аэропорт:

- "Шереметьево", "SVO"
- "Домодедово", "DME"
- "Внуково", "VKO"
- "Пулково", "LED"

### Формат даты

Инструмент поддерживает широкий спектр форматов дат на русском и английском языках:

#### Простые относительные даты

| Выражение (RU) | Выражение (EN) | Описание | Пример результата (от 2026-02-02) |
|----------------|----------------|----------|-----------------------------------|
| сегодня | today | Текущий день | 2026-02-02 |
| завтра | tomorrow | Следующий день | 2026-02-03 |
| послезавтра | - | Через два дня | 2026-02-04 |
| вчера | yesterday | Предыдущий день | 2026-02-01 |
| позавчера | - | Два дня назад | 2026-01-31 |

**Примеры запросов:**
- "Найди рейсы из Москвы в Питер на завтра"
- "Show flights from Moscow to Sochi tomorrow"

#### Дни недели

| Выражение (RU) | Выражение (EN) | Описание | Пример результата (от 2026-02-02, понедельник) |
|----------------|----------------|----------|-----------------------------------------------|
| понедельник | monday | Ближайший понедельник (не сегодня) | 2026-02-09 |
| вторник | tuesday | Ближайший вторник | 2026-02-03 |
| в среду | on wednesday | Ближайшая среда | 2026-02-04 |
| следующий четверг | next thursday | Четверг следующей недели | 2026-02-12 |
| в пятницу | on friday | Ближайшая пятница | 2026-02-06 |

**Примеры запросов:**
- "Покажи самолёты из Сочи в Екатеринбург в пятницу"
- "Find flights from Vladivostok to Moscow next Monday"

#### Смещения

| Выражение (RU) | Выражение (EN) | Описание | Пример результата (от 2026-02-02) |
|----------------|----------------|----------|-----------------------------------|
| через 3 дня | in 3 days | Через N дней | 2026-02-05 |
| через неделю | in a week | Через 7 дней | 2026-02-09 |
| через месяц | in a month | Через 1 месяц | 2026-03-02 |

**Примеры запросов:**
- "Найди рейсы из Москвы в Сочи через 3 дня"
- "Search flights from Moscow to Petersburg in a week"

#### Абсолютные даты

| Формат | Пример (RU) | Пример (EN) | Описание |
|--------|-------------|-------------|----------|
| YYYY-MM-DD | 2026-02-15 | 2026-02-15 | ISO формат |
| DD.MM.YYYY | 15.02.2026 | - | Точечный формат |
| MM/DD/YYYY | - | 02/15/2026 | Американский формат |
| DD месяц | 15 февраля | - | Русский текстовый формат |
| месяц DD | - | February 15 | Английский текстовый формат |

**Примеры запросов:**
- "Найди рейсы на 15 февраля"
- "Show flights on February 15"

#### Важно: Периоды не поддерживаются

Инструмент НЕ поддерживает периоды, так как требуется конкретная дата вылета:

❌ **Не работает:**
- "следующая неделя" / "next week"
- "этот месяц" / "this month"
- "через 2 недели" / "in 2 weeks"

✅ **Используйте вместо этого:**
- "понедельник" / "monday" (конкретный день недели)
- "через 7 дней" / "in 7 days" (конкретное смещение)
- "15 февраля" / "February 15" (конкретная дата)

## Ограничения

### Поддерживаются только:

- ✅ Авиарейсы (самолёты)
- ✅ Внутренние рейсы по России

### Не поддерживаются:

- ❌ Международные рейсы
- ❌ Поезда
- ❌ Автобусы
- ❌ Электрички

При запросе неподдерживаемого типа транспорта или международного рейса, инструмент вежливо откажет и объяснит ограничение.

## Примеры ответов

### Успешный поиск

```json
{
  "success": true,
  "found": true,
  "count": 5,
  "total_found": 12,
  "from": "Москва",
  "from_airport": "Шереметьево",
  "to": "Санкт-Петербург",
  "to_airport": "Пулково",
  "date": "2026-02-01",
  "flights": [...],
  "message": "Найдено 5 авиарейсов из Москвы (Шереметьево) в Санкт-Петербург (Пулково) на 2026-02-01:\n1. Аэрофлот SU1234: вылет 10:00, прилёт 11:30 (1ч 30мин)\n..."
}
```

### Успешный поиск с относительной датой

```json
{
  "success": true,
  "found": true,
  "count": 5,
  "total_found": 12,
  "from": "Москва",
  "from_airport": "Шереметьево",
  "to": "Санкт-Петербург",
  "to_airport": "Пулково",
  "date": "2026-02-03",
  "original_date": "завтра",
  "flights": [...],
  "message": "Найдено 5 авиарейсов из Москвы (Шереметьево) в Санкт-Петербург (Пулково) на завтра (2026-02-03):\n..."
}
```

### Период не поддерживается

```json
{
  "success": false,
  "error": "period_not_allowed",
  "message": "Для поиска авиарейсов укажите конкретную дату вылета, а не период. Вы указали: 'следующая неделя' (период с 2026-02-09 по 2026-02-15). Попробуйте указать конкретный день, например: 'завтра', 'понедельник', 'через 3 дня'"
}
```

### Аэропорт не найден

```json
{
  "success": false,
  "error": "airport_not_found",
  "message": "Аэропорт отправления 'Мосва' не найден. Возможно вы имели в виду: Москва?",
  "suggestions": ["Москва", "Минеральные Воды", "Мурманск"]
}
```

### Рейсы не найдены

```json
{
  "success": true,
  "found": false,
  "message": "Прямых авиарейсов из Москвы в Санкт-Петербург на 2026-02-01 не найдено. Попробуйте выбрать другую дату или рассмотрите рейсы с пересадками.",
  "from": "Москва",
  "to": "Санкт-Петербург",
  "date": "2026-02-01"
}
```

### Международный рейс

```json
{
  "success": false,
  "error": "international_not_supported",
  "message": "Извините, я знаю расписание только по авиарейсам внутри России. Париж находится в стране: Франция",
  "from": "Москва",
  "to": "Париж"
}
```

## Обновление справочника аэропортов

Справочник автоматически обновляется раз в 30 дней (настраивается через `cache_ttl_days` в конфигурации).

Для принудительного обновления:

```bash
rm data/airports_russia.json
python scripts/download_airports.py
```

## Устранение неполадок

### Ошибка: "YANDEX_RASP_API_KEY не установлен"

Убедитесь что файл `.env` существует и содержит ключ:

```bash
cat .env | grep YANDEX_RASP_API_KEY
```

### Ошибка: "Не удалось загрузить справочник аэропортов"

Проверьте подключение к интернету и запустите скрипт загрузки:

```bash
python scripts/download_airports.py
```

### Аэропорт не находится

Попробуйте разные варианты названия:

- Полное название города
- Сокращённое название
- Название аэропорта
- IATA код (например, SVO, LED)

## Тестирование

### Запуск unit-тестов

```bash
pytest tests/unit/test_airport_registry.py -v
```

### Запуск integration-тестов

```bash
pytest tests/integration/test_flights_tool.py -v
```

### Запуск всех тестов

```bash
pytest tests/ -v
```

## Конфигурация

Настройки инструмента в `config/config.yml`:

```yaml
tools:
  flights:
    enabled: true
    cache_file: "data/airports_russia.json"
    cache_ttl_days: 30
    only_russia: true
    only_planes: true
```

Параметры:

- `enabled` - включить/выключить инструмент
- `cache_file` - путь к файлу кэша аэропортов
- `cache_ttl_days` - срок жизни кэша в днях
- `only_russia` - ограничение только на Россию
- `only_planes` - ограничение только на самолёты
